#!/bin/bash
# Setup WordPress for contributing.

if [[ -z "$LANDO_MOUNT" ]]; then
    echo "Error: Must be run the appserver.";
    exit 1
fi

set -e
set -x

if [[ ! -e "$LANDO_MOUNT/public/core-dev" ]]; then
    git clone https://github.com/WordPress/wordpress-develop.git "$LANDO_MOUNT/public/core-dev"
fi

if [[ ! -e "$LANDO_MOUNT/public/core-dev/.svn" ]]; then
    cd "$LANDO_MOUNT"
    svn co --ignore-externals https://develop.svn.wordpress.org/trunk/ tmp-svn
    mv tmp-svn/.svn public/core-dev/.svn
    rm -rf tmp-svn
fi

CONFIG_FILE="$LANDO_MOUNT/public/core-dev/wp-config.php"
if [[ ! -e "$CONFIG_FILE" ]]; then
    echo "<?php" >> "$CONFIG_FILE"
    echo "// DO NOT EDIT THIS FILE! Please put customizations in the git-ignored wp-config-local.php!" >> "$CONFIG_FILE"
    echo "require_once dirname( dirname( __FILE__ ) ) . '/wp-config.php';" >> "$CONFIG_FILE"
    echo "require_once ABSPATH . 'wp-settings.php';" >> "$CONFIG_FILE"
fi

CONFIG_FILE="$LANDO_MOUNT/public/core-dev/wp-tests-config.php"
if [[ ! -e "$CONFIG_FILE" ]]; then
    echo "<?php" >> "$CONFIG_FILE"
    echo "// DO NOT EDIT THIS FILE! Please put customizations in the git-ignored wp-tests-config-local.php!" >> "$CONFIG_FILE"
    echo >> "$CONFIG_FILE"

    echo "// If testing core, run from 'build' directory. Otherwise, run from 'src' directory." >> "$CONFIG_FILE"
    echo "if ( defined( 'WP_RUN_CORE_TESTS' ) && WP_RUN_CORE_TESTS ) {" >> "$CONFIG_FILE"
    echo "	define( 'WP_TESTS_CORE_PATH_RELATIVE', basename( dirname( __FILE__ ) ) . '/build' );" >> "$CONFIG_FILE"
    echo "} else {" >> "$CONFIG_FILE"
    echo "	define( 'WP_TESTS_CORE_PATH_RELATIVE', basename( dirname( __FILE__ ) ) . '/src' );" >> "$CONFIG_FILE"
    echo "}" >> "$CONFIG_FILE"
    echo "require_once dirname( dirname( __FILE__ ) ) . '/wp-tests-config.php';" >> "$CONFIG_FILE"
fi

if [[ ! -e "$LANDO_MOUNT/public/core-dev/vendor" ]]; then
    cd $LANDO_MOUNT/public/core-dev
    composer install
fi

if [[ ! -e "$LANDO_MOUNT/public/core-dev/node_modules" ]]; then
    cd "$LANDO_MOUNT/public/core-dev"
    npm install
fi

if [[ ! -e "$LANDO_MOUNT/public/core-dev/build" ]]; then
    cd "$LANDO_MOUNT/public/core-dev"
    npx grunt
fi

cd "$LANDO_MOUNT/public/core-dev"
if ! git config -l --local | grep -q 'alias.svn-up'; then
    git config alias.svn-up '! ../../bin/svn-git-up $1';
fi

if ! wp core is-installed; then
  wp core install --url="https://$LANDO_APP_NAME.$LANDO_DOMAIN/" --title="WordPress Develop" --admin_name="admin" --admin_email="admin@local.test" --admin_password="password"
  wp rewrite structure '/%year%/%monthnum%/%day%/%postname%/'
fi
